<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMPERIUM - Ma Cit√©</title>
    <meta name="description" content="G√©rez votre cit√© romaine, construisez des b√¢timents et d√©veloppez votre empire.">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' fill='%23b45309'/><text x='16' y='20' text-anchor='middle' fill='white' font-family='serif' font-size='20' font-weight='bold'>I</text></svg>" type="image/svg+xml">

    <!-- Styles et scripts communs -->
    <link rel="stylesheet" href="../common-styles.css">
    <script src="../common-navigation.js"></script>
    <script src="../game-engine.js"></script>
    <script src="../ui-manager.js"></script>

    <style>
        /* Styles sp√©cifiques √† la cit√© */
        .city-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            height: calc(100% - 100px);
        }

        .city-map {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 1rem;
            border: 2px solid var(--gold-primary);
            padding: 2rem;
            position: relative;
            overflow: hidden;
        }

        .buildings-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 0.5rem;
            height: 100%;
            min-height: 500px;
        }

        .building-slot {
            background: rgba(30, 41, 59, 0.6);
            border: 2px dashed var(--border-gold);
            border-radius: 0.8rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 80px;
        }

        .building-slot:hover {
            border-color: var(--gold-light);
            background: rgba(217, 119, 6, 0.1);
            transform: scale(1.05);
        }

        .building-slot.occupied {
            background: rgba(217, 119, 6, 0.2);
            border: 2px solid var(--gold-primary);
        }

        .building-slot.occupied:hover {
            background: rgba(217, 119, 6, 0.3);
            border-color: var(--gold-light);
        }

        .building-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            filter: drop-shadow(0 0 10px var(--shadow-gold));
        }

        .building-name {
            color: var(--gold-light);
            font-weight: bold;
            font-size: 0.8rem;
            text-align: center;
            margin-bottom: 0.2rem;
        }

        .building-level {
            color: var(--text-muted);
            font-size: 0.7rem;
        }

        .building-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0 0 0.6rem 0.6rem;
            overflow: hidden;
        }

        .building-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--gold-primary), var(--gold-light));
            transition: width 0.3s ease;
        }

        .city-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .panel-section {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 1rem;
            border: 1px solid var(--border-gold);
            padding: 1.5rem;
        }

        .section-title {
            color: var(--gold-primary);
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .city-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .stat-item {
            text-align: center;
            background: rgba(30, 41, 59, 0.6);
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-gold);
        }

        .stat-value {
            color: var(--gold-light);
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.3rem;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .production-list {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .production-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(30, 41, 59, 0.6);
            padding: 0.8rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-gold);
        }

        .production-resource {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .production-icon {
            font-size: 1.2rem;
        }

        .production-name {
            color: var(--text-light);
            font-weight: bold;
        }

        .production-rate {
            color: var(--gold-light);
            font-weight: bold;
        }

        .storage-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .storage-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
        }

        .storage-bar {
            flex: 1;
            height: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            margin: 0 1rem;
            overflow: hidden;
        }

        .storage-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold-primary), var(--gold-light));
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .storage-text {
            color: var(--text-light);
            font-size: 0.8rem;
            min-width: 80px;
            text-align: right;
        }

        /* Actions rapides */
        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .quick-action-btn {
            padding: 1rem;
            background: rgba(30, 41, 59, 0.8);
            color: var(--text-light);
            border: 1px solid var(--border-gold);
            border-radius: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Times New Roman', serif;
            font-weight: bold;
            text-align: center;
        }

        .quick-action-btn:hover {
            border-color: var(--gold-light);
            background: rgba(217, 119, 6, 0.1);
            transform: translateY(-2px);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .city-layout {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
            }
            
            .buildings-grid {
                grid-template-columns: repeat(4, 1fr);
                grid-template-rows: repeat(4, 1fr);
                min-height: 300px;
            }
            
            .city-panel {
                max-height: 400px;
                overflow-y: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Particules d'arri√®re-plan -->
    <div class="particles"></div>

    <!-- INTERFACE PRINCIPALE DU JEU -->
    <div class="imperium-ui">
        <!-- HEADER -->
        <header class="imperium-header">
            <div class="header-content">
                <h1 class="imperium-logo">IMPERIUM</h1>
                <div id="resources-display" class="resources-display">
                    <!-- Les ressources seront inject√©es ici par JS -->
                </div>
                <div class="player-info">
                    <div class="player-avatar" id="player-avatar">M</div>
                    <div>
                        <div class="player-name" id="player-name"></div>
                        <div class="player-level" id="player-title-level"></div>
                    </div>
                </div>
            </div>
        </header>

        <!-- CORPS PRINCIPAL -->
        <div class="imperium-body">
            <!-- BARRE LATERALE (Desktop) -->
            <aside class="imperium-sidebar">
                <!-- Navigation g√©n√©r√©e dynamiquement par common-navigation.js -->
            </aside>

            <!-- CONTENU PRINCIPAL -->
            <main class="main-content">
                <div class="view-container">
                    <h2 class="view-title">Ma Cit√© Romaine</h2>
                    <div class="city-layout">
                        <!-- Carte de la cit√© -->
                        <div class="city-map">
                            <div id="buildings-grid" class="buildings-grid">
                                <!-- Les emplacements de b√¢timents seront g√©n√©r√©s par JS -->
                            </div>
                        </div>

                        <!-- Panneau d'informations -->
                        <div class="city-panel">
                            <!-- Statistiques de la cit√© -->
                            <div class="panel-section">
                                <h3 class="section-title">üìä Statistiques</h3>
                                <div class="city-stats">
                                    <div class="stat-item">
                                        <div class="stat-value" id="population-value">75</div>
                                        <div class="stat-label">Population</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value" id="happiness-value">60</div>
                                        <div class="stat-label">Bonheur</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value" id="max-population-value">75</div>
                                        <div class="stat-label">Pop. Max</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value" id="city-level-value">1</div>
                                        <div class="stat-label">Niveau</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Production -->
                            <div class="panel-section">
                                <h3 class="section-title">‚ö° Production / heure</h3>
                                <div id="production-list" class="production-list">
                                    <!-- G√©n√©r√© par JS -->
                                </div>
                            </div>

                            <!-- Stockage -->
                            <div class="panel-section">
                                <h3 class="section-title">üì¶ Stockage</h3>
                                <div id="storage-list" class="storage-list">
                                    <!-- G√©n√©r√© par JS -->
                                </div>
                            </div>

                            <!-- Files d'attente -->
                            <div class="panel-section">
                                <h3 class="section-title">üèóÔ∏è Construction</h3>
                                <div id="building-queue-main" class="queue-container">
                                    <p class="queue-empty">Aucune construction en cours</p>
                                </div>
                            </div>

                            <div class="panel-section">
                                <h3 class="section-title">‚öîÔ∏è Recrutement</h3>
                                <div id="recruitment-queue-main" class="queue-container">
                                    <p class="queue-empty">Aucun recrutement en cours</p>
                                </div>
                            </div>

                            <!-- Actions rapides -->
                            <div class="panel-section">
                                <h3 class="section-title">‚ö° Actions Rapides</h3>
                                <div class="quick-actions">
                                    <button class="quick-action-btn" id="save-btn">üíæ Sauvegarder</button>
                                    <button class="quick-action-btn" id="load-btn">üìÅ Charger</button>
                                    <button class="quick-action-btn" onclick="location.href='../Developpement/Academie.html'">üìö Acad√©mie</button>
                                    <button class="quick-action-btn" onclick="location.href='../Militaire/L√©gions.html'">‚öîÔ∏è L√©gions</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Variables globales
        let uiManager;
        
        // Initialisation du jeu
        document.addEventListener('DOMContentLoaded', function() {
            // Initialiser le moteur de jeu
            gameEngine.init();
            
            // Initialiser le gestionnaire d'interface
            uiManager = new ImperiumUIManager(gameEngine);
            
            // G√©n√©rer la grille de b√¢timents
            generateBuildingsGrid();
            
            // Mettre √† jour l'interface
            updateCityInterface();
            
            console.log('üèõÔ∏è IMPERIUM - Cit√© initialis√©e avec succ√®s!');
        });
        
        // G√©n√©ration de la grille de b√¢timents
        function generateBuildingsGrid() {
            const grid = document.getElementById('buildings-grid');
            const gameState = gameEngine.getGameState();
            const city = gameState.cities.main;
            
            // Cr√©er une grille 6x6
            for (let y = 0; y < 6; y++) {
                for (let x = 0; x < 6; x++) {
                    const slot = document.createElement('div');
                    slot.className = 'building-slot';
                    slot.dataset.x = x;
                    slot.dataset.y = y;
                    
                    // V√©rifier s'il y a un b√¢timent √† cette position
                    const building = findBuildingAtPosition(city.buildings, x, y);
                    
                    if (building) {
                        slot.classList.add('occupied');
                        slot.dataset.building = building.type;
                        
                        const config = BUILDINGS_CONFIG[building.type];
                        slot.innerHTML = `
                            <div class="building-icon">${config.icon}</div>
                            <div class="building-name">${config.name}</div>
                            <div class="building-level">Niveau ${building.level}</div>
                        `;
                    } else {
                        slot.innerHTML = `
                            <div class="building-icon">‚ûï</div>
                            <div class="building-name">Construire</div>
                        `;
                    }
                    
                    grid.appendChild(slot);
                }
            }
        }
        
        // Trouver un b√¢timent √† une position donn√©e
        function findBuildingAtPosition(buildings, x, y) {
            for (const [type, building] of Object.entries(buildings)) {
                if (building.x === x && building.y === y) {
                    return { type, ...building };
                }
            }
            return null;
        }
        
        // Mise √† jour de l'interface de la cit√©
        function updateCityInterface() {
            const gameState = gameEngine.getGameState();
            const city = gameState.cities.main;
            
            // Statistiques de la cit√©
            document.getElementById('population-value').textContent = Math.floor(city.population);
            document.getElementById('happiness-value').textContent = city.happiness;
            document.getElementById('max-population-value').textContent = gameEngine.calculateMaxPopulation('main');
            document.getElementById('city-level-value').textContent = city.buildings.forum ? city.buildings.forum.level : 0;
            
            // Production
            updateProductionDisplay();
            
            // Stockage
            updateStorageDisplay();
        }
        
        // Mise √† jour de l'affichage de la production
        function updateProductionDisplay() {
            const production = gameEngine.calculateProduction('main');
            const productionList = document.getElementById('production-list');
            
            productionList.innerHTML = Object.keys(production).map(resource => {
                const rate = production[resource];
                const config = RESOURCES_CONFIG[resource];
                
                return `
                    <div class="production-item">
                        <div class="production-resource">
                            <span class="production-icon">${config.icon}</span>
                            <span class="production-name">${config.name}</span>
                        </div>
                        <span class="production-rate">+${rate.toFixed(1)}/h</span>
                    </div>
                `;
            }).join('');
        }
        
        // Mise √† jour de l'affichage du stockage
        function updateStorageDisplay() {
            const resources = gameEngine.getResources();
            const capacity = gameEngine.calculateStorageCapacity('main');
            const storageList = document.getElementById('storage-list');
            
            storageList.innerHTML = Object.keys(resources).map(resource => {
                const current = resources[resource];
                const max = capacity[resource];
                const percentage = Math.min(100, (current / max) * 100);
                const config = RESOURCES_CONFIG[resource];
                
                return `
                    <div class="storage-item">
                        <span class="production-icon">${config.icon}</span>
                        <div class="storage-bar">
                            <div class="storage-fill" style="width: ${percentage}%"></div>
                        </div>
                        <span class="storage-text">${Math.floor(current)}/${Math.floor(max)}</span>
                    </div>
                `;
            }).join('');
        }
        
        // Mise √† jour p√©riodique de l'interface
        setInterval(() => {
            updateCityInterface();
            updateBuildingsGrid();
        }, 1000);
        
        // Mise √† jour de la grille de b√¢timents
        function updateBuildingsGrid() {
            const gameState = gameEngine.getGameState();
            const city = gameState.cities.main;
            
            // Mettre √† jour les barres de progression des constructions en cours
            if (city.buildingQueue) {
                city.buildingQueue.forEach(building => {
                    const slot = document.querySelector(`[data-x="${building.x}"][data-y="${building.y}"]`);
                    if (slot) {
                        const progress = uiManager.calculateProgress(building.startTime, building.endTime);
                        
                        // Ajouter la barre de progression si elle n'existe pas
                        if (!slot.querySelector('.building-progress')) {
                            const progressBar = document.createElement('div');
                            progressBar.className = 'building-progress';
                            progressBar.innerHTML = '<div class="building-progress-bar"></div>';
                            slot.appendChild(progressBar);
                        }
                        
                        // Mettre √† jour la progression
                        const progressBarFill = slot.querySelector('.building-progress-bar');
                        if (progressBarFill) {
                            progressBarFill.style.width = progress + '%';
                        }
                    }
                });
            }
        }
        
        // Gestion des √©v√©nements sp√©cifiques √† la cit√©
        gameEngine.on('buildingCompleted', (data) => {
            // R√©g√©n√©rer la grille quand un b√¢timent est termin√©
            setTimeout(() => {
                const grid = document.getElementById('buildings-grid');
                grid.innerHTML = '';
                generateBuildingsGrid();
            }, 100);
        });
        
        // Fonction pour obtenir des conseils de d√©veloppement
        function getCityAdvice() {
            const gameState = gameEngine.getGameState();
            const city = gameState.cities.main;
            const resources = gameEngine.getResources();
            const advice = [];
            
            // Conseils bas√©s sur l'√©tat de la cit√©
            if (city.happiness < 50) {
                advice.push("üç∫ Construisez une Taverne pour am√©liorer le bonheur de vos citoyens");
            }
            
            if (!city.buildings.warehouse || city.buildings.warehouse.level < 3) {
                advice.push("üì¶ Am√©liorez votre Entrep√¥t pour augmenter la capacit√© de stockage");
            }
            
            if (resources.wood < 500) {
                advice.push("üå≤ Construisez plus de Camps de B√ªcherons pour la production de bois");
            }
            
            if (!city.buildings.academy) {
                advice.push("üìö Construisez une Acad√©mie pour d√©bloquer les technologies");
            }
            
            if (!city.buildings.barracks) {
                advice.push("‚öîÔ∏è Construisez une Caserne pour recruter des l√©gions");
            }
            
            return advice;
        }
        
        // Afficher les conseils (peut √™tre appel√© depuis la console ou un bouton)
        function showCityAdvice() {
            const advice = getCityAdvice();
            if (advice.length > 0) {
                uiManager.showNotification('Conseils de d√©veloppement', advice.join('\n'), 'info', 10000);
            } else {
                uiManager.showNotification('F√©licitations', 'Votre cit√© se d√©veloppe parfaitement!', 'success');
            }
        }
        
        // Fonction de d√©bogage pour ajouter des ressources (d√©veloppement)
        function addResources(resource, amount) {
            if (typeof gameState !== 'undefined') {
                gameState.resources[resource] = (gameState.resources[resource] || 0) + amount;
                uiManager.showNotification('Debug', `+${amount} ${resource} ajout√©`, 'info');
            }
        }
        
        // Raccourcis clavier pour le d√©veloppement
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey) {
                switch(e.key) {
                    case 'S':
                        e.preventDefault();
                        uiManager.saveGame();
                        break;
                    case 'L':
                        e.preventDefault();
                        uiManager.loadGame();
                        break;
                    case 'A':
                        e.preventDefault();
                        showCityAdvice();
                        break;
                    case 'R':
                        e.preventDefault();
                        // Ajouter 1000 de chaque ressource (debug)
                        Object.keys(RESOURCES_CONFIG).forEach(resource => {
                            addResources(resource, 1000);
                        });
                        break;
                }
            }
        });
    </script>
</body>
</html>